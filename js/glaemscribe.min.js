/*
Gl«Ωmscribe (also written Glaemscribe) is a software dedicated to
the transcription of texts between writing systems, and more 
specifically dedicated to the transcription of J.R.R. Tolkien's 
invented languages to some of his devised writing systems.

Copyright (C) 2017 Benjamin Babut (Talagan).

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

Version : 1.3.1
*/

"use strict";function stringListToCleanArray(e,r){return e.split(r).map(function(e){return e.trim()}).filter(function(e){return""!=e})}function productizeArray(e,r){for(var t=new Array(e.length*r.length),s=0;s<e.length;s++)for(var a=0;a<r.length;a++)t[s*r.length+a]=[e[s],r[a]];return t}function arrayEquals(e,r){if(!r)return!1;if(e.length!=r.length)return!1;for(var t=0,s=e.length;t<s;t++)if(Array.isArray(e[t])&&Array.isArray(r[t])){if(!arrayEquals(e[t],r[t]))return!1}else if(e[t]!=r[t])return!1;return!0}function uniqueArray(e){return e.filter(function(e,r,t){return t.indexOf(e)===r})}function glaemEach(e,r){for(var t in e){if(e.hasOwnProperty(t))if(0==r(t,e[t]))break}}function glaemEachReversed(e,r){if(!Array.isArray(e))return glaemEach(e,r);for(var t=e.length-1;0<=t;t--){if(e.hasOwnProperty(t))if(0==r(t,e[t]))break}}String.fromCodePoint||function(){var e=function(){try{var e={},r=Object.defineProperty,t=r(e,e,e)&&r}catch(s){}return t}(),l=String.fromCharCode,c=Math.floor,r=function(){var e,r,t=16384,s=[],a=-1,o=arguments.length;if(!o)return"";for(var n="";++a<o;){var i=Number(arguments[a]);if(!isFinite(i)||i<0||1114111<i||c(i)!=i)throw RangeError("Invalid code point: "+i);i<=65535?s.push(i):(e=55296+((i-=65536)>>10),r=i%1024+56320,s.push(e,r)),(a+1==o||s.length>t)&&(n+=l.apply(null,s),s.length=0)}return n};e?e(String,"fromCodePoint",{value:r,configurable:!0,writable:!0}):String.fromCodePoint=r}(),Function.prototype.inheritsFrom=function(e){return e.constructor==Function?(this.prototype=new e,(this.prototype.constructor=this).prototype.parent=e.prototype):(this.prototype=e,(this.prototype.constructor=this).prototype.parent=e),this};var Glaemscribe={WORD_BREAKER:"|",WORD_BOUNDARY_LANG:"_",WORD_BOUNDARY_TREE:"\0",UNKNOWN_CHAR_OUTPUT:"\u2620",VIRTUAL_CHAR_OUTPUT:"\u2622",ResourceManager:function(){return this.raw_modes={},this.raw_charsets={},this.loaded_modes={},this.loaded_charsets={},this.pre_processor_operator_classes={},this.post_processor_operator_classes={},this}};Glaemscribe.ResourceManager.prototype.load_charsets=function(e){null==e&&(e=Object.keys(this.raw_charsets)),("string"==typeof e||e instanceof String)&&(e=[e]);for(var r=0;r<e.length;r++){var t=e[r];if(!this.loaded_charsets[t]&&this.raw_charsets[t]){var s=(new Glaemscribe.CharsetParser).parse(t);s&&(this.loaded_charsets[t]=s)}}},Glaemscribe.ResourceManager.prototype.load_modes=function(e){null==e&&(e=Object.keys(this.raw_modes)),("string"==typeof e||e instanceof String)&&(e=[e]);for(var r=0;r<e.length;r++){var t=e[r];if(!this.loaded_modes[t]&&this.raw_modes[t]){var s=(new Glaemscribe.ModeParser).parse(t);s&&(this.loaded_modes[t]=s)}}},Glaemscribe.ResourceManager.prototype.register_pre_processor_class=function(e,r){this.pre_processor_operator_classes[e]=r},Glaemscribe.ResourceManager.prototype.register_post_processor_class=function(e,r){this.post_processor_operator_classes[e]=r},Glaemscribe.ResourceManager.prototype.class_for_pre_processor_operator_name=function(e){return this.pre_processor_operator_classes[e]},Glaemscribe.ResourceManager.prototype.class_for_post_processor_operator_name=function(e){return this.post_processor_operator_classes[e]},Glaemscribe.resource_manager=new Glaemscribe.ResourceManager,Glaemscribe.Char=function(){return this},Glaemscribe.Char.prototype.is_virtual=function(){return!1},Glaemscribe.Char.prototype.is_sequence=function(){return!1},Glaemscribe.Char.prototype.output=function(){return this.str},Glaemscribe.Swap=function(e,r){this.trigger=e,this.targets={},this.target_list=r},Glaemscribe.Swap.prototype.finalize=function(a){var o=this;o.lookup_table={};var e=a.n2c(o.trigger);return e||a.errors.push(new Glaemscribe.Glaeml.Error(o.line," Swap operator triggers "+o.trigger+" which does not exist in charset.")),glaemEach(o.target_list,function(e){var r=o.target_list[e],t=a.n2c(r);if(t)for(e=0;e<t.names.length;e++){var s=t.names[e];o.targets[s]=t}else a.errors.push(new Glaemscribe.Glaeml.Error(o.line," Swap operator targets "+r+" which does not exist in charset."))}),e},Glaemscribe.Swap.prototype.has_target=function(e){var r=this.targets[e];return r!==undefined&&null!==r},Glaemscribe.VirtualChar=function(){return this.classes=[],this.lookup_table={},this.reversed=!1,this["default"]=null,this},Glaemscribe.VirtualChar.VirtualClass=function(){this.target="",this.triggers=[]},Glaemscribe.VirtualChar.prototype.is_virtual=function(){return!0},Glaemscribe.VirtualChar.prototype.is_sequence=function(){return!1},Glaemscribe.VirtualChar.prototype.output=function(){var e=this;return e["default"]?e.charset.n2c(e["default"]).output():Glaemscribe.VIRTUAL_CHAR_OUTPUT},Glaemscribe.VirtualChar.prototype.finalize=function(){var o=this;if(o.lookup_table={},glaemEach(o.classes,function(e,r){var a=r.target;glaemEach(r.triggers,function(e,r){if(null!=o.lookup_table[r])o.charset.errors.push(new Glaemscribe.Glaeml.Error(o.line,"Trigger char "+r+"found twice in virtual char."));else{var t=o.charset.n2c(a),s=o.charset.n2c(r);null==t?o.charset.errors.push(new Glaemscribe.Glaeml.Error(o.line,"Trigger char "+r+" points to unknown result char "+a+".")):null==s?o.charset.errors.push(new Glaemscribe.Glaeml.Error(o.line,"Unknown trigger char "+r+".")):t instanceof Glaemscribe.VirtualChar?o.charset.errors.push(new Glaemscribe.Glaeml.Error(o.line,"Trigger char "+r+" points to another virtual char "+a+". This is not supported!")):glaemEach(s.names,function(e,r){o.lookup_table[r]=t})}})}),o["default"]){var e=o.charset.lookup_table[o["default"]];e?e.is_virtual()&&o.charset.errors.push(new Glaemscribe.Glaeml.Error(o.line,"Default char "+o["default"]+" is virtual, it should be real only.")):o.charset.errors.push(new Glaemscribe.Glaeml.Error(o.line,"Default char "+o["default"]+" does not match any real character in the charset."))}},Glaemscribe.VirtualChar.prototype.n2c=function(e){return this.lookup_table[e]},Glaemscribe.SequenceChar=function(){return this.sequence=[],this},Glaemscribe.SequenceChar.prototype.is_virtual=function(){return!1},Glaemscribe.SequenceChar.prototype.is_sequence=function(){return!0},Glaemscribe.SequenceChar.prototype.str=function(){return Glaemscribe.VIRTUAL_CHAR_OUTPUT},Glaemscribe.SequenceChar.prototype.finalize=function(){var t=this;0==t.sequence.length&&t.charset.errors.push(new Glaemscribe.Glaeml.Error(t.line,"Sequence for sequence char is empty.")),glaemEach(t.sequence,function(e,r){t.charset.n2c(r)||t.charset.errors.push(new Glaemscribe.Glaeml.Error(t.line,"Sequence char "+r+"cannot be found in the charset."))})},Glaemscribe.Charset=function(e){return this.name=e,this.chars=[],this.errors=[],this.swaps=[],this},Glaemscribe.Charset.prototype.add_char=function(e,r,t){if(t!=undefined&&0!=t.length&&-1==t.indexOf("?")){var s=new Glaemscribe.Char;s.line=e,s.code=r,s.names=t,s.str=String.fromCodePoint(r),(s.charset=this).chars.push(s)}},Glaemscribe.Charset.prototype.add_virtual_char=function(e,r,t,s,a){if(t!=undefined&&0!=t.length&&-1==t.indexOf("?")){var o=new Glaemscribe.VirtualChar;o.line=e,o.names=t,o.classes=r,o.charset=this,o["default"]=a,o.reversed=s,this.chars.push(o)}},Glaemscribe.Charset.prototype.add_sequence_char=function(e,r,t){if(r!=undefined&&0!=r.length&&-1==r.indexOf("?")){var s=new Glaemscribe.SequenceChar;s.line=e,s.names=r,s.sequence=stringListToCleanArray(t,/\s/),(s.charset=this).chars.push(s)}},Glaemscribe.Charset.prototype.add_swap=function(e,r,t){if(r!=undefined&&""!=r&&t!=undefined&&0!=t.length){var s=new Glaemscribe.Swap(r,t);s.line=e,this.swaps.push(s)}},Glaemscribe.Charset.prototype.finalize=function(){var o=this;o.errors=[],o.lookup_table={},o.virtual_chars=[],o.swap_lookup={},o.chars=o.chars.sort(function(e,r){return e.is_virtual()&&r.is_virtual()?e.names[0].localeCompare(r.names[0]):e.is_virtual()?1:r.is_virtual()?-1:e.code-r.code});for(var e=0;e<o.chars.length;e++)for(var r=o.chars[e],t=0;t<r.names.length;t++){var s=r.names[t];null!=o.lookup_table[s]?o.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Character "+s+" found twice.")):o.lookup_table[s]=r}glaemEach(o.chars,function(e,r){r.is_virtual()&&(r.finalize(),o.virtual_chars.push(r))}),glaemEach(o.chars,function(e,r){r.is_sequence()&&r.finalize()}),glaemEach(o.swaps,function(e,r){var t=r.finalize(o);if(t)for(var s=0;s<t.names.length;s++){var a=t.names[s];o.swap_lookup[a]=r}})},Glaemscribe.Charset.prototype.n2c=function(e){return this.lookup_table[e]},Glaemscribe.Charset.prototype.swap_for_trigger=function(e){return this.swap_lookup[e]},Glaemscribe.CharsetParser=function(){return this},Glaemscribe.CharsetParser.prototype.parse_raw=function(e,r){var n=new Glaemscribe.Charset(e),t=(new Glaemscribe.Glaeml.Parser).parse(r);if(0<t.errors.length)return n.errors=t.errors,n;for(var s=t.root_node.gpath("char"),a=0;a<s.length;a++){var o=s[a],i=parseInt(o.args[0],16),l=o.args.slice(1);n.add_char(o.line,i,l)}return glaemEach(t.root_node.gpath("seq"),function(e,r){var t=r.args,s=r.children[0],a=s&&s.is_text()?s.args[0]:"";n.add_sequence_char(r.line,t,a)}),glaemEach(t.root_node.gpath("swap"),function(e,r){var t=r.args[0],s=r.children.filter(function(e){return e.is_text()}).map(function(e){return e.args[0]}).join(" ").split(/\s/).filter(function(e){return""!==e});n.add_swap(r.line,t,s)}),glaemEach(t.root_node.gpath("virtual"),function(e,r){var t=r.args,a=[],s=!1,o=null;glaemEach(r.gpath("class"),function(e,r){var t=new Glaemscribe.VirtualChar.VirtualClass;t.target=r.args[0],t.triggers=r.args.slice(1);var s=r.children.filter(function(e){return e.is_text()}).map(function(e){return e.args[0]}).join(" ").split(/\s/).filter(function(e){return""!==e});t.triggers=t.triggers.concat(s),a.push(t)}),glaemEach(r.gpath("reversed"),function(){s=!0}),glaemEach(r.gpath("default"),function(e,r){o=r.args[0]}),n.add_virtual_char(r.line,a,t,s,o)}),n.finalize(),n},Glaemscribe.CharsetParser.prototype.parse=function(e){var r=Glaemscribe.resource_manager.raw_charsets[e];return this.parse_raw(e,r)},Glaemscribe.Glaeml={},Glaemscribe.Glaeml.Document=function(){return this.errors=[],this.root_node=null,this},Glaemscribe.Glaeml.NodeType={},Glaemscribe.Glaeml.NodeType.Text=0,Glaemscribe.Glaeml.NodeType.ElementInline=1,Glaemscribe.Glaeml.NodeType.ElementBlock=2,Glaemscribe.Glaeml.Node=function(e,r,t){return this.type=r,this.name=t,this.line=e,this.args=[],this.children=[],this},Glaemscribe.Glaeml.Node.prototype.clone=function(){var t=new Glaemscribe.Glaeml.Node(this.line,this.type,this.name);return t.args=this.args.slice(0),glaemEach(this.children,function(e,r){t.children.push(r.clone())}),t},Glaemscribe.Glaeml.Node.prototype.is_text=function(){return this.type==Glaemscribe.Glaeml.NodeType.Text},Glaemscribe.Glaeml.Node.prototype.is_element=function(){return this.type==Glaemscribe.Glaeml.NodeType.ElementInline||this.type==Glaemscribe.Glaeml.NodeType.ElementBlock},Glaemscribe.Glaeml.Node.prototype.pathfind_crawl=function(e,r){for(var t=this,s=0;s<t.children.length;s++){var a=t.children[s];if(a.name==e[0])if(1==e.length)r.push(a);else{var o=e.slice(0);o.shift(),a.pathfind_crawl(o,r)}}},Glaemscribe.Glaeml.Node.prototype.gpath=function(e){var r=e.split("."),t=[];return this.pathfind_crawl(r,t),t},Glaemscribe.Glaeml.Error=function(e,r){return this.line=e,this.text=r,this},Glaemscribe.Glaeml.Parser=function(){},Glaemscribe.Glaeml.Parser.prototype.add_text_node=function(e,r){var t=new Glaemscribe.Glaeml.Node(e,Glaemscribe.Glaeml.NodeType.Text,null);t.args.push(r),t.parent_node=this.current_parent_node,this.current_parent_node.children.push(t)},Glaemscribe.Glaeml.Parser.prototype.parse=function(e){e=(e=e.replace(/\r/g,"")).replace(/\\\*\*([\s\S]*?)\*\*\\/gm,function(e){return new Array((e.match(/\n/g)||[]).length+1).join("\n")});var r=0,t=this,s=new Glaemscribe.Glaeml.Document;s.root_node=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementBlock,"root"),t.current_parent_node=s.root_node;for(var a=e.split("\n"),o=0;o<a.length;o++){r+=1;var n=a[o];if(""!=(n=n.trim()))if("\\"==n[0])if(1==n.length)s.errors.push(new Glaemscribe.Glaeml.Error(r,"Incomplete Node"));else{var i=null;if("\\"==n[1])t.add_text_node(r,n.substring(1));else if(i=n.match(/^(\\beg\s+)/)){var l=i[0],c=n.substring(l.length),p=[],u="???";if(i=c.match(/^([a-z_]+)/)){u=i[0];try{p=(new Glaemscribe.Glaeml.Shellwords).parse(c.substring(u.length))}catch(h){s.errors.push(new Glaemscribe.Glaeml.Error(r,"Error parsing glaeml args ("+h+")."))}}else s.errors.push(new Glaemscribe.Glaeml.Error(r,"Bad element name."));var _=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementBlock,u);_.args=_.args.concat(p),_.parent_node=t.current_parent_node,t.current_parent_node.children.push(_),t.current_parent_node=_}else if(i=n.match(/^(\\end(\s|$))/))t.current_parent_node.parent_node?""!=n.substring(i[0].length).trim()?s.errors.push(new Glaemscribe.Glaeml.Error(r,"Element 'end' should not have any argument.")):t.current_parent_node=t.current_parent_node.parent_node:s.errors.push(new Glaemscribe.Glaeml.Error(r,"Element 'end' unexpected."));else if(i=(n=n.substring(1)).match(/^([a-z_]+)/)){u=i[0],p=[];try{p=(new Glaemscribe.Glaeml.Shellwords).parse(n.substring(u.length))}catch(h){s.errors.push(new Glaemscribe.Glaeml.Error(r,"Error parsing glaeml args ("+h+")."))}(_=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementInline,u)).args=_.args.concat(p),_.parent_node=t.current_parent_node,t.current_parent_node.children.push(_)}else s.errors.push(new Glaemscribe.Glaeml.Error(r,"Cannot understand element name."))}else t.add_text_node(r,n);else t.add_text_node(r,n)}return t.current_parent_node!=s.root_node&&s.errors.push(new Glaemscribe.Glaeml.Error(r,"Missing 'end' element.")),s},Glaemscribe.Glaeml.Shellwords=function(){return this},Glaemscribe.Glaeml.ShellwordsEscapeMode={},Glaemscribe.Glaeml.ShellwordsEscapeMode.Unicode=1,Glaemscribe.Glaeml.Shellwords.prototype.reset_state=function(){var e=this;e.is_escaping=!1,e.is_eating_arg=!1,e.is_eating_arg_between_quotes=!1,e.args=[],e.current_arg="",e.escape_mode=null,e.unicode_escape_counter=0,e.unicode_escape_str=""},Glaemscribe.Glaeml.Shellwords.prototype.advance_inside_arg=function(e,r){var t=this;"\\"==e[r]?(t.is_escaping=!0,t.escape_mode=null):t.current_arg+=e[r]},Glaemscribe.Glaeml.Shellwords.prototype.advance_inside_escape=function(e,r){var t=this;if(null==t.escape_mode)switch(e[r]){case"n":t.current_arg+="\n",t.is_escaping=!1;break;case"\\":t.current_arg+="\\",t.is_escaping=!1;break;case"t":t.current_arg+="\t",t.is_escaping=!1;break;case'"':t.current_arg+='"',t.is_escaping=!1;break;case"u":t.escape_mode=Glaemscribe.Glaeml.ShellwordsEscapeMode.Unicode,t.unicode_escape_counter=0,t.unicode_escape_str="";break;default:throw new Error("Unknown escapment : \\"+e[r])}else switch(t.escape_mode){case Glaemscribe.Glaeml.ShellwordsEscapeMode.Unicode:var s=e[r].toLowerCase();if(!s.match(/[0-9a-f]/))throw new Error("Wrong format for unicode escaping, should be \\u with 4 hex digits");t.unicode_escape_counter+=1,t.unicode_escape_str+=s,4==t.unicode_escape_counter&&(t.is_escaping=!1,t.current_arg+=String.fromCodePoint(parseInt(t.unicode_escape_str,16)));break;default:throw new Error("Unimplemented escape mode")}},Glaemscribe.Glaeml.Shellwords.prototype.parse=function(e){var r=this;r.reset_state();for(var t=0;t<e.length;t++)if(r.is_eating_arg)if(r.is_escaping)r.advance_inside_escape(e,t);else if(r.is_eating_arg_between_quotes)'"'==e[t]?(r.args.push(r.current_arg),r.current_arg="",r.is_eating_arg=!1):r.advance_inside_arg(e,t);else{if(e[t].match(/[\s"]/)){r.args.push(r.current_arg),r.current_arg="",r.is_eating_arg='"'==e[t],r.is_eating_arg_between_quotes=r.is_eating_arg;continue}r.advance_inside_arg(e,t)}else{if(e[t].match(/\s/))continue;if("'"==e[t])throw new Error("Glaeml strictly uses double quotes, not simple quotes for args");r.is_eating_arg=!0,r.is_eating_arg_between_quotes='"'==e[t],r.is_eating_arg_between_quotes||(r.current_arg+=e[t])}if(r.is_eating_arg&&r.is_eating_arg_between_quotes)throw new Error("Unmatched quote.");return""!=r.current_arg.trim()&&r.args.push(r.current_arg),r.args},Glaemscribe.Fragment=function(e,r){var t=this;if(t.sheaf=e,t.mode=e.mode,t.rule=e.rule,t.expression=r,t.equivalences=stringListToCleanArray(t.expression,Glaemscribe.Fragment.EQUIVALENCE_RX_OUT),t.equivalences=t.equivalences.map(function(e){var r=Glaemscribe.Fragment.EQUIVALENCE_RX_IN.exec(e);return r?r[1].split(Glaemscribe.Fragment.EQUIVALENCE_SEPARATOR).map(function(e){return(e=e.trim()).split(/\s/).map(function(e){return t.finalize_fragment_leaf(e)})}):[e.split(/\s/).map(function(e){return t.finalize_fragment_leaf(e)})]}),0==t.equivalences.length&&(t.equivalences=[[[""]]]),t.is_dst())for(var s=t.sheaf.mode,a=0;a<t.equivalences.length;a++)for(var o=t.equivalences[a],n=0;n<o.length;n++)for(var i=o[n],l=0;l<i.length;l++){var c=i[l];if(""!=c)for(var p in s.supported_charsets){var u=s.supported_charsets[p];if(null==u.n2c(c))return void t.rule.errors.push("Symbol '"+c+"' not found in charset '"+u.name+"'!")}}var _=t.equivalences[0];for(a=0;a<t.equivalences.length-1;a++){_=productizeArray(_,t.equivalences[a+1]).map(function(e){var r=e[0],t=e[1];return r.concat(t)})}t.combinations=_},Glaemscribe.Fragment.prototype.finalize_fragment_leaf=function(e){return this.is_src()&&(e=(e=(e=e.replace(Glaemscribe.RuleGroup.UNICODE_VAR_NAME_REGEXP_OUT,function(e,r){var t=String.fromCodePoint(parseInt(r,16));return"_"==t&&(t="\x01"),t})).replace(new RegExp(Glaemscribe.WORD_BOUNDARY_LANG,"g"),Glaemscribe.WORD_BOUNDARY_TREE)).replace(new RegExp("\x01","g"),"_")),e},Glaemscribe.Fragment.EQUIVALENCE_SEPARATOR=",",Glaemscribe.Fragment.EQUIVALENCE_RX_OUT=/(\(.*?\))/,Glaemscribe.Fragment.EQUIVALENCE_RX_IN=/\((.*?)\)/,Glaemscribe.Fragment.prototype.is_src=function(){return this.sheaf.is_src()},Glaemscribe.Fragment.prototype.is_dst=function(){return this.sheaf.is_dst()},Glaemscribe.ModeDebugContext=function(){return this.preprocessor_output="",this.processor_pathes=[],this.processor_output=[],this.postprocessor_output="",this.tts_output="",this},Glaemscribe.Mode=function(e){return this.name=e,this.supported_charsets={},this.options={},this.errors=[],this.warnings=[],this.latest_option_values={},this.has_tts=!1,this.current_tts_voice=null,this.raw_mode_name=null,this.pre_processor=new Glaemscribe.TranscriptionPreProcessor(this),this.processor=new Glaemscribe.TranscriptionProcessor(this),this.post_processor=new Glaemscribe.TranscriptionPostProcessor(this),this},Glaemscribe.Mode.prototype.finalize=function(e){var s=this;null==e&&(e={});var a={};glaemEach(s.options,function(e,r){a[e]=r.default_value_name}),glaemEach(e,function(e,r){var t=s.options[e];return!t||(null==t.value_for_value_name(r)||void(a[e]=r))});var t={};if(glaemEach(a,function(e,r){t[e]=s.options[e].value_for_value_name(r)}),glaemEach(s.options,function(e,r){r.type==Glaemscribe.Option.Type.ENUM&&glaemEach(r.values,function(e,r){t[e]=r})}),this.latest_option_values=t,this.pre_processor.finalize(this.latest_option_values),this.post_processor.finalize(this.latest_option_values),this.processor.finalize(this.latest_option_values),s.get_raw_mode()&&s.get_raw_mode().finalize(e),this.has_tts){var r=s.options.espeak_voice.value_name_for_value(s.latest_option_values.espeak_voice);this.current_tts_voice=Glaemscribe.TTS.option_name_to_voice(r)}return this},Glaemscribe.Mode.prototype.get_raw_mode=function(){var e=this;if(null!=e.raw_mode)return e.raw_mode;var r=e.raw_mode_name&&Glaemscribe.resource_manager.loaded_modes[e.raw_mode_name];return null==r?null:(e.raw_mode=Object.glaem_clone(r),e.raw_mode)},Glaemscribe.Mode.prototype.strict_transcribe=function(e,r,t){var s=this;if(null==r&&(r=this.default_charset),null==r)return[!1,"*** No charset usable for transcription. Failed!"];if(s.has_tts)try{e=(new Glaemscribe.TTS).synthesize_ipa(e,{voice:s.current_tts_voice,has_raw_mode:null!=s.get_raw_mode()}).ipa,t.tts_output+=e}catch(c){return[!1,"TTS pre-transcription failed : "+c]}for(var a="",o=e.split(/(\n)/),n=0;n<o.length;n++){var i=o[n],l=!1;"\n"==i[i.length-1]&&(l=!0,i=i.slice(0,-1)),i=this.pre_processor.apply(i),t.preprocessor_output+=i+"\n",i=this.processor.apply(i,t),t.processor_output=t.processor_output.concat(i),i=this.post_processor.apply(i,r),t.postprocessor_output+=i+"\n",l&&(i+="\n"),a+=i}return[!0,a,t]},Glaemscribe.Mode.prototype.transcribe=function(e,l){var c=this,p=new Glaemscribe.ModeDebugContext,u=c.get_raw_mode(),_="",r=!0;if(null!=u){glaemEach(e.split(/({{[\s\S]*?}})/),function(e,r){var t=null,s=r,a=c;(t=r.match(/{{([\s\S]*?)}}/))&&(s=t[1],a=u);var o=a.strict_transcribe(s,l,p),n=o[0],i=o[1];if(!n)return[!1,i,p];_+=i})}else{var t=c.strict_transcribe(e,l,p),s=t[0],a=t[1];if(!s)return[!1,a,p];_+=a}return[r,_,p]},Glaemscribe.Option=function(e,r,t,s,a,o){var n=this;return this.mode=e,this.name=r,this.default_value_name=t,this.type=0==Object.keys(s).length?Glaemscribe.Option.Type.BOOL:Glaemscribe.Option.Type.ENUM,this.values=s,this.visibility=o,this.line=a,n.value_to_names={},glaemEach(n.values,function(e,r){n.value_to_names[r]=e}),this},Glaemscribe.Option.Type={},Glaemscribe.Option.Type.BOOL="BOOL",Glaemscribe.Option.Type.ENUM="ENUM",Glaemscribe.Option.prototype.default_value=function(){return this.type==Glaemscribe.Option.Type.BOOL?"true"==this.default_value_name:this.values[this.default_value_name]},Glaemscribe.Option.prototype.value_for_value_name=function(e){return this.type==Glaemscribe.Option.Type.BOOL?"true"==e||1==e||"false"!=e&&0!=e&&null:this.values[e]},Glaemscribe.Option.prototype.value_name_for_value=function(e){return this.type==Glaemscribe.Option.Type.BOOL?1==e||"true"==e?"true":0==e||"false"==e?"false":null:this.value_to_names[e]},Glaemscribe.Option.prototype.is_visible=function(){var e=new Glaemscribe.Eval.Parser;try{return 1==e.parse(this.visibility||"true",this.mode.latest_option_values||{})}catch(r){return console.log(r),null}},Glaemscribe.Macro=function(e,r,t){var s=this;s.rule_group=e,s.module=e.mode,s.name=e.name,s.arg_names=t,s.root_code_block=new Glaemscribe.IfTree.CodeBlock},Glaemscribe.ModeParser=function(){return this},Glaemscribe.ModeParser.prototype.validate_presence_of_args=function(e,r){var t=this;null!=r&&e.args.length!=r&&t.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Element '"+e.name+"' should have "+r+" arguments."))},Glaemscribe.ModeParser.prototype.validate_presence_of_children=function(e,r,t,s){var a=this,o=e.gpath(r);t&&o.length!=t&&a.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Element '"+e.name+"' should have exactly "+t+" children of type '"+r+"'.")),s&&glaemEach(o,function(e,r){a.validate_presence_of_args(r,s)})},Glaemscribe.ModeParser.prototype.verify_mode_glaeml=function(e){var t=this;t.validate_presence_of_children(e.root_node,"language",1,1),t.validate_presence_of_children(e.root_node,"writing",1,1),t.validate_presence_of_children(e.root_node,"mode",1,1),t.validate_presence_of_children(e.root_node,"authors",1,1),t.validate_presence_of_children(e.root_node,"version",1,1),glaemEach(e.root_node.gpath("charset"),function(e,r){t.validate_presence_of_args(r,2)}),glaemEach(e.root_node.gpath("options.option"),function(e,r){t.validate_presence_of_args(r,2),glaemEach(r.gpath("value"),function(e,r){t.validate_presence_of_args(r,2)})}),glaemEach(e.root_node.gpath("outspace"),function(e,r){t.validate_presence_of_args(r,1)}),glaemEach(e.root_node.gpath("processor.rules"),function(e,r){t.validate_presence_of_args(r,1),t.validate_presence_of_children(r,"if",null,1),t.validate_presence_of_children(r,"elsif",null,1)}),glaemEach(e.root_node.gpath("preprocessor.if"),function(e,r){t.validate_presence_of_args(r,1)}),glaemEach(e.root_node.gpath("preprocessor.elsif"),function(e,r){t.validate_presence_of_args(r,1)}),glaemEach(e.root_node.gpath("postprocessor.if"),function(e,r){t.validate_presence_of_args(r,1)}),glaemEach(e.root_node.gpath("postprocessor.elsif"),function(e,r){t.validate_presence_of_args(r,1)}),glaemEach(e.root_node.children,function(e,r){"if"===r.name&&t.mode.errors.push(Glaemscribe.Glaeml.Error(r.line,"'if' conditions are not allowed in that scope."))})},Glaemscribe.ModeParser.prototype.create_if_cond_for_if_term=function(e,r,t){var s=new Glaemscribe.IfTree.IfCond(e,r,t),a=new Glaemscribe.IfTree.CodeBlock(s);return s.child_code_block=a,r.if_conds.push(s),s},Glaemscribe.ModeParser.prototype.traverse_if_tree=function(e,r,t){for(var s=this.mode,a=e.owner,o=e.root_element,n=e.rule_group,i=a.root_code_block,l=0;l<o.children.length;l++){var c=o.children[l];if(c.is_text())null!=r&&r(i,c);else if(c.is_element())switch(c.name){case"if":var p=c.args[0],u=new Glaemscribe.IfTree.IfTerm(i);i.terms.push(u),i=this.create_if_cond_for_if_term(c.line,u,p).child_code_block;break;case"elsif":p=c.args[0];if(null==(u=i.parent_if_cond.parent_if_term))return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"'elsif' without a 'if'."));i=this.create_if_cond_for_if_term(c.line,u,p).child_code_block;break;case"else":if(null==(u=i.parent_if_cond.parent_if_term))return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"'else' without a 'if'."));i=this.create_if_cond_for_if_term(c.line,u,"true").child_code_block;break;case"endif":if(null==(u=i.parent_if_cond.parent_if_term))return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"'endif' without a 'if'."));i=u.parent_code_block;break;case"macro":if(i.parent_if_cond||"rules"!=o.name)return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Macros can only defined in the 'rules' scope, not in a conditional block (because they are replaced and used at parsing time) or a macro block (local macros are not handled)."));if(!c.args||0==c.args.length)return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Macro misses a name."));var _=(m=c.args.slice(0)).shift();if(glaemEach(m,function(e,r){r.match(/[0-9A-Z_]+/)||s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Macro argument name "+r+" has wrong format."))}),null!=n.macros[_])return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Redefining macro "+_+"."));var h={owner:f=new Glaemscribe.Macro(n,_,m),root_element:c,rule_group:n};this.traverse_if_tree(h,r,t),n.macros[_]=f;break;case"deploy":if(!n)return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Macros can only be deployed in a rule group."));var m,f;_=(m=c.args.slice(0)).shift();if(null==(f=n.macros[_]))return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Macro '"+_+"' not found in rule group '"+n.name+"'."));var b=f.arg_names.length,d=m.length;if(b!=d)return void s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Macro '"+_+"' takes "+b+" arguments, not "+d+"."));var G=new Glaemscribe.IfTree.MacroDeployTerm(f,c.line,i,m);i.terms.push(G);break;default:null!=t&&t(i,c)}}i.parent_if_cond&&s.errors.push(new Glaemscribe.Glaeml.Error(c.line,"Unended 'if' at the end of this '"+o.name+"' element."))},Glaemscribe.ModeParser.prototype.parse_pre_post_processor=function(e,o){var n=this.mode,r=function(){},t=function(e,r){var t=e.terms[e.terms.length-1];null!=t&&t.is_pre_post_processor_operators()||(t=new Glaemscribe.IfTree.PrePostProcessorOperatorsTerm(e),e.terms.push(t));var s=r.name,a=null;(a=o?Glaemscribe.resource_manager.class_for_pre_processor_operator_name(s):Glaemscribe.resource_manager.class_for_post_processor_operator_name(s))?t.operators.push(new a(n,r.clone())):n.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Operator '"+s+"' is unknown."))},s={owner:o?n.pre_processor:n.post_processor,root_element:e,rule_group:null};this.traverse_if_tree(s,r,t)},Glaemscribe.ModeParser.prototype.parse_raw=function(e,r,t){var l=new Glaemscribe.Mode(e);if(null==((this.mode=l).raw=r))return l.errors.push(new Glaemscribe.Glaeml.Error(0,"No sourcecode. Forgot to load it?")),l;null==t&&(t={});var s=(new Glaemscribe.Glaeml.Parser).parse(r);if(0<s.errors.length)return l.errors=s.errors,l;if(this.verify_mode_glaeml(s),0<l.errors.length)return l;l.language=s.root_node.gpath("language")[0].args[0],l.writing=s.root_node.gpath("writing")[0].args[0],l.human_name=s.root_node.gpath("mode")[0].args[0],l.authors=s.root_node.gpath("authors")[0].args[0],l.version=s.root_node.gpath("version")[0].args[0],l.invention=(s.root_node.gpath("invention")[0]||{args:[]}).args[0],l.world=(s.root_node.gpath("world")[0]||{args:[]}).args[0],l.raw_mode_name=(s.root_node.gpath("raw_mode")[0]||{args:[]}).args[0],glaemEach(s.root_node.gpath("options.option"),function(e,r){var s={},t=null,a=!1;glaemEach(r.gpath("value"),function(e,r){var t=r.args[0];s[t]=parseInt(r.args[1])}),glaemEach(r.gpath("visible_when"),function(e,r){t=r.args[0]}),glaemEach(r.gpath("radio"),function(){a=!0});var o=r.args[0],n=r.args[1];null==n&&l.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Missing option 'default' value."));var i=new Glaemscribe.Option(l,o,n,s,r.line,t);i.is_radio=a,l.options[i.name]=i});for(var a=s.root_node.gpath("charset"),o=0;o<a.length;o++){var n=a[o],i=n.args[0],c=Glaemscribe.resource_manager.loaded_charsets[i];if(c||(Glaemscribe.resource_manager.load_charsets([i]),c=Glaemscribe.resource_manager.loaded_charsets[i]),c){if(0<c.errors.length){for(var p=0;p<c.errors.length;p++){var u=c.errors[p];l.errors.push(new Glaemscribe.Glaeml.Error(n.line,i+":"+u.line+":"+u.text))}return l}l.supported_charsets[i]=c;var _=n.args[1];_&&"true"==_&&(l.default_charset=c)}else l.warnings.push(new Glaemscribe.Glaeml.Error(n.line,"Failed to load charset '"+i+"'."))}l.default_charset||l.warnings.push(new Glaemscribe.Glaeml.Error(0,"No default charset defined!!"));var h=s.root_node.gpath("preprocessor")[0];h&&this.parse_pre_post_processor(h,!0);var m=s.root_node.gpath("postprocessor")[0];m&&this.parse_pre_post_processor(m,!1);var f=s.root_node.gpath("outspace")[0];if(f){var b=f.args[0];l.post_processor.out_space=stringListToCleanArray(b,/\s/)}for(var d=s.root_node.gpath("processor.rules"),G=0;G<d.length;G++){var g=d[G],v=g.args[0],y=new Glaemscribe.RuleGroup(l,v),T=function(e,r){var t=e.terms[e.terms.length-1];null!=t&&t.is_code_lines()||(t=new Glaemscribe.IfTree.CodeLinesTerm(e),e.terms.push(t));for(var s=r.line,a=r.args[0].split("\n"),o=0;o<a.length;o++){var n=a[o].trim(),i=new Glaemscribe.IfTree.CodeLine(n,s);t.code_lines.push(i),s+=1}},E=function(e,r){l.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Unknown directive "+r.name+"."))},w={owner:l.processor.rule_groups[v]=y,root_element:g,rule_group:y};this.traverse_if_tree(w,T,E)}var P=l.options.espeak_voice;return P&&(l.has_tts=!0,glaemEach(P.values,function(e){var r=Glaemscribe.TTS.option_name_to_voice(e);Glaemscribe.TTS.voice_list().includes(r)||l.errors.push(new Glaemscribe.Glaeml.Error(P.line,"Option has unhandled voice  "+r+"."))})),0==l.errors.length&&l.finalize(t),l},Glaemscribe.ModeParser.prototype.parse=function(e){var r=this,t=Glaemscribe.resource_manager.raw_modes[e];return r.parse_raw(e,t)},Glaemscribe.Rule=function(e,r){this.line=e,this.rule_group=r,this.mode=r.mode,this.sub_rules=[],this.errors=[]},Glaemscribe.Rule.prototype.finalize=function(e){if(0<this.errors.length)for(var r=0;r<this.errors.length;r++){var t=this.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,t))}else{var s=new Glaemscribe.SheafChainIterator(this.src_sheaf_chain),a=new Glaemscribe.SheafChainIterator(this.dst_sheaf_chain,e);if(0<s.errors.length)for(r=0;r<s.errors.length;r++){t=s.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,t))}else if(0<a.errors.length)for(r=0;r<a.errors.length;r++){t=a.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,t))}else{var o=s.proto(),n=a.proto();if(o==n){do{for(var i=s.combinations(),l=a.combinations()[0],c=0;c<i.length;c++){var p=i[c];this.sub_rules.push(new Glaemscribe.SubRule(this,p,l))}a.iterate()}while(s.iterate())}else this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,"Source and destination are not compatible ("+o+" vs "+n+")"))}}},Glaemscribe.RuleGroupVar=function(e,r,t){this.name=e,this.value=r,this.is_p=t},Glaemscribe.RuleGroupVar.prototype.is_pointer=function(){return this.is_p},Glaemscribe.RuleGroup=function(e,r){return this.name=r,this.mode=e,this.macros={},this.root_code_block=new Glaemscribe.IfTree.CodeBlock,this},Glaemscribe.RuleGroup.VAR_NAME_REGEXP=/{([0-9A-Z_]+)}/g,Glaemscribe.RuleGroup.VAR_DECL_REGEXP=/^\s*{([0-9A-Z_]+)}\s+===\s+(.+?)\s*$/,Glaemscribe.RuleGroup.POINTER_VAR_DECL_REGEXP=/^\s*{([0-9A-Z_]+)}\s+<=>\s+(.+?)\s*$/,Glaemscribe.RuleGroup.UNICODE_VAR_NAME_REGEXP_IN=/^UNI_([0-9A-F]+)$/,Glaemscribe.RuleGroup.UNICODE_VAR_NAME_REGEXP_OUT=/{UNI_([0-9A-F]+)}/,Glaemscribe.RuleGroup.RULE_REGEXP=/^\s*(.*?)\s+-->\s+(.+?)\s*$/,Glaemscribe.RuleGroup.CROSS_SCHEMA_REGEXP=/[0-9]+(\s*,\s*[0-9]+)*/,Glaemscribe.RuleGroup.CROSS_RULE_REGEXP=/^\s*(.*?)\s+-->\s+([0-9]+(\s*,\s*[0-9]+)*|{([0-9A-Z_]+)}|identity)\s+-->\s+(.+?)\s*$/,Glaemscribe.RuleGroup.prototype.add_var=function(e,r,t){
this.vars[e]=new Glaemscribe.RuleGroupVar(e,r,t)},Glaemscribe.RuleGroup.prototype.apply_vars=function(o,n,i){for(var l=this,c=this.mode,p=!1,e=n,u=!0,r=0;u;){if(u=!1,e=e.replace(Glaemscribe.RuleGroup.VAR_NAME_REGEXP,function(e,r){var t=r,s=l.vars[t],a=null;if(null==s){if(!Glaemscribe.RuleGroup.UNICODE_VAR_NAME_REGEXP_IN.exec(t))return c.errors.push(new Glaemscribe.Glaeml.Error(o,"In expression: "+n+": failed to evaluate variable: "+e+".")),p=!0,"";if(!i)return c.errors.push(new Glaemscribe.Glaeml.Error(o,"In expression: "+n+": making wrong use of unicode variable: "+e+". Unicode vars can only be used in source members of a rule or in the definition of another variable.")),p=!0,"";a=e}else a=s.value,u=!0;return a}),p)return null;if(r+=1,!u)break;if(16<r)return c.errors.push(new Glaemscribe.Glaeml.Error(o,"In expression: "+n+": evaluation stack overflow.")),nil}return e},Glaemscribe.RuleGroup.prototype.descend_if_tree=function(e,r){for(var a=this,o=this.mode,t=0;t<e.terms.length;t++){var n=e.terms[t];if(n.is_code_lines())for(var s=0;s<n.code_lines.length;s++){var i=n.code_lines[s];this.finalize_code_line(i)}else if(n.is_macro_deploy()){var l=new Glaemscribe.Glaeml.Error(n.line,">> Macro backtrace : "+n.macro.name);o.errors.push(l);var c=[];glaemEach(n.macro.arg_names,function(e,r){var t=null;if(a.vars[r])o.errors.push(new Glaemscribe.Glaeml.Error(n.line,"Local variable "+r+" hinders a variable with the same name in this context. Use only local variable names in macros!"));else{var s=n.arg_value_expressions[e];null==(t=a.apply_vars(n.line,s,!0))&&o.errors.push(new Glaemscribe.Glaeml.Error(n.line,"Thus, variable "+var_name+" could not be declared."))}c.push({name:r,val:t})}),glaemEach(c,function(e,r){null!=r.val&&a.add_var(r.name,r.val,!1)}),a.descend_if_tree(n.macro.root_code_block,r),glaemEach(c,function(e,r){null!=r.val&&(a.vars[r.name]=null)}),o.errors[o.errors.length-1]==l?o.errors.pop():o.errors.push(new Glaemscribe.Glaeml.Error(n.line,"<< Macro backtrace : "+n.macro.name))}else for(var p=0;p<n.if_conds.length;p++){var u=n.if_conds[p],_=new Glaemscribe.Eval.Parser,h=!1;try{h=_.parse(u.expression,r)}catch(m){o.errors.push(new Glaemscribe.Glaeml.Error(u.line,"Failed to evaluate condition '"+u.expression+"'."))}if(1==h){this.descend_if_tree(u.child_code_block,r);break}}}},Glaemscribe.RuleGroup.prototype.finalize_rule=function(e,r,t,s){var a=this.apply_vars(e,r,!0),o=this.apply_vars(e,t,!1);if(null!=a&&null!=o){var n=new Glaemscribe.Rule(e,this);n.src_sheaf_chain=new Glaemscribe.SheafChain(n,a,!0),n.dst_sheaf_chain=new Glaemscribe.SheafChain(n,o,!1),n.finalize(s),this.rules.push(n)}},Glaemscribe.RuleGroup.prototype.finalize_code_line=function(e){var r=this.mode,t=Glaemscribe.RuleGroup.VAR_DECL_REGEXP.exec(e.expression);if(t){var s=t[1],a=t[2];if(null==(l=this.apply_vars(e.line,a,!0)))return void r.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Thus, variable {"+s+"} could not be declared."));this.add_var(s,l,!1)}else if(t=Glaemscribe.RuleGroup.POINTER_VAR_DECL_REGEXP.exec(e.expression)){s=t[1],a=t[2];this.add_var(s,a,!0)}else if(t=Glaemscribe.RuleGroup.CROSS_RULE_REGEXP.exec(e.expression)){var o=t[1],n=t[2],i=(s=t[4],t[5]);if(s){var l;if(!(l=this.apply_vars(e.line,n,!1)))return void r.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Thus, variable {"+s+"} could not be declared."));n=l}"identity"==n&&(n=null),this.finalize_rule(e.line,o,i,n)}else if(t=Glaemscribe.RuleGroup.RULE_REGEXP.exec(e.expression)){o=t[1],i=t[2];this.finalize_rule(e.line,o,i)}else""==e.expression||r.errors.push(new Glaemscribe.Glaeml.Error(e.line,": Cannot understand '"+e.expression+"'."))},Glaemscribe.RuleGroup.prototype.finalize=function(e){var r=this;this.vars={},this.in_charset={},this.rules=[],this.add_var("NULL","",!1),this.add_var("NBSP","{UNI_A0}",!1),this.add_var("WJ","{UNI_2060}",!1),this.add_var("ZWSP","{UNI_200B}",!1),this.add_var("ZWNJ","{UNI_200C}",!1),this.add_var("UNDERSCORE","{UNI_5F}",!1),this.add_var("ASTERISK","{UNI_2A}",!1),this.add_var("COMMA","{UNI_2C}",!1),this.add_var("LPAREN","{UNI_28}",!1),this.add_var("RPAREN","{UNI_29}",!1),this.add_var("LBRACKET","{UNI_5B}",!1),this.add_var("RBRACKET","{UNI_5D}",!1),this.descend_if_tree(this.root_code_block,e),r.in_charset={};for(var t=0;t<r.rules.length;t++)for(var s=r.rules[t],a=0;a<s.sub_rules.length;a++)for(var o=s.sub_rules[a].src_combination.join("").split(""),n=0;n<o.length;n++){var i=o[n];i!=Glaemscribe.WORD_BREAKER&&i!=Glaemscribe.WORD_BOUNDARY_TREE&&(r.in_charset[i]=r)}},Glaemscribe.SubRule=function(e,r,t){this.src_combination=r,this.dst_combination=t},Glaemscribe.Sheaf=function(e,r,t){var s=this;s.sheaf_chain=e,s.mode=e.mode,s.rule=e.rule,s.expression=r,s.linkable=t,s.fragment_exps=r.split(Glaemscribe.Sheaf.SHEAF_SEPARATOR).map(function(e){return e.trim()}),0==s.fragment_exps.length&&(s.fragment_exps=[""]),s.fragments=s.fragment_exps.map(function(e){return new Glaemscribe.Fragment(s,e)})},Glaemscribe.Sheaf.SHEAF_SEPARATOR="*",Glaemscribe.Sheaf.prototype.is_src=function(){return this.sheaf_chain.is_src},Glaemscribe.Sheaf.prototype.is_dst=function(){return!this.sheaf_chain.is_src},Glaemscribe.Sheaf.prototype.mode=function(){return this.sheaf_chain.mode()},Glaemscribe.SheafChain=function(e,r,t){var s=this;return s.rule=e,s.mode=e.mode,s.is_src=t,s.expression=r,s.sheaf_exps=stringListToCleanArray(r,Glaemscribe.SheafChain.SHEAF_REGEXP_OUT),s.sheaf_exps=s.sheaf_exps.map(function(e){var r=Glaemscribe.SheafChain.SHEAF_REGEXP_IN.exec(e),t=!1;return r&&(e=r[1],t=!0),{exp:e.trim(),linkable:t}}),s.sheaves=s.sheaf_exps.map(function(e){return new Glaemscribe.Sheaf(s,e.exp,e.linkable)}),0==s.sheaves.length&&(s.sheaves=[new Glaemscribe.Sheaf(s,"",!1)]),s},Glaemscribe.SheafChain.SHEAF_REGEXP_IN=/\[(.*?)\]/,Glaemscribe.SheafChain.SHEAF_REGEXP_OUT=/(\[.*?\])/,Glaemscribe.SheafChain.prototype.mode=function(){return this.rule.mode()},Glaemscribe.SheafChainIterator=function(e,r){var a=this;a.sheaf_chain=e,a.sizes=e.sheaves.map(function(e){return e.fragments.length}),a.iterators=a.sizes.map(function(){return 0}),a.errors=[];for(var t=[],s=e.sheaves.length,o=0;o<s;o++)t.push(o);var n=[],i=[];if(glaemEach(e.sheaves,function(e,r){r.linkable&&(n.push(e),i.push(r.fragments.length))}),a.cross_array=t,a.proto_attr=i.join("x"),""==a.proto_attr&&(a.proto_attr="CONST"),null!=r){r=r.split(",").map(function(e){return parseInt(e)-1});var l=n.length,c=r.length;if(c!=l)return void a.errors.push(l+" linkable sheaves found in right predicate, but "+c+" elements in cross rule.");var p=[];for(o=0;o<l;o++)p.push(o);if(!arrayEquals(p,r.slice(0).sort()))return void a.errors.push("Cross rule schema should be a permutation of the identity (it should contain 1,2,..,n numbers once and only once).");var u=i.slice(0);glaemEach(r,function(e,r){var t=n[e],s=n[r];a.cross_array[t]=s,u[e]=i[r]}),i=u}a.proto_attr=i.join("x"),""==a.proto_attr&&(a.proto_attr="CONST")},Glaemscribe.SheafChainIterator.prototype.proto=function(){return this.proto_attr},Glaemscribe.SheafChainIterator.prototype.combinations=function(){for(var e=this,r=[],t=0;t<e.iterators.length;t++){var s=e.iterators[t],a=e.sheaf_chain.sheaves[t].fragments[s];r.push(a.combinations)}var o=r[0];for(t=0;t<r.length-1;t++){o=productizeArray(o,r[t+1]).map(function(e){var r=e[0],t=e[1];return r.concat(t)})}return o},Glaemscribe.SheafChainIterator.prototype.iterate=function(){for(var e=this,r=0;r<e.sizes.length;){var t=e.cross_array[r];if(e.iterators[t]+=1,!(e.iterators[t]>=e.sizes[t]))return!0;e.iterators[t]=0,r+=1}return!1},Glaemscribe.IfTree={},Glaemscribe.IfTree.IfCond=function(e,r,t){return this.line=e,this.parent_if_term=r,this.expression=t,this},Glaemscribe.IfTree.Term=function(e){return this.parent_code_block=e,this},Glaemscribe.IfTree.Term.prototype.is_code_lines=function(){return!1},Glaemscribe.IfTree.Term.prototype.is_macro_deploy=function(){return!1},Glaemscribe.IfTree.Term.prototype.is_pre_post_processor_operators=function(){return!1},Glaemscribe.IfTree.Term.prototype.name=function(){return"TERM"},Glaemscribe.IfTree.Term.prototype.dump=function(e){for(var r="",t=0;t<e;t++)r+=" ";r+="|-"+this.name(),console.log(r)},Glaemscribe.IfTree.IfTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.if_conds=[],this},Glaemscribe.IfTree.IfTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.IfTerm.prototype.name=function(){return"IF_TERM"},Glaemscribe.IfTree.IfTerm.prototype.dump=function(e){this.parent.dump.call(this,e)},Glaemscribe.IfTree.CodeLine=function(e,r){return this.expression=e,this.line=r,this},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.operators=[],this},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.prototype.name=function(){return"OP_TERM"},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.prototype.is_pre_post_processor_operators=function(){return!0},Glaemscribe.IfTree.CodeLinesTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.code_lines=[],this},Glaemscribe.IfTree.CodeLinesTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.CodeLinesTerm.prototype.name=function(){return"CL_TERM"},Glaemscribe.IfTree.CodeLinesTerm.prototype.is_code_lines=function(){return!0},Glaemscribe.IfTree.MacroDeployTerm=function(e,r,t,s){return Glaemscribe.IfTree.Term.call(this,t),this.line=r,this.macro=e,this.arg_value_expressions=s,this},Glaemscribe.IfTree.MacroDeployTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.MacroDeployTerm.prototype.name=function(){return"DEPLOY_TERM"},Glaemscribe.IfTree.MacroDeployTerm.prototype.is_macro_deploy=function(){return!0},Glaemscribe.IfTree.CodeBlock=function(e){return this.parent_if_cond=e,this.terms=[],this},Glaemscribe.IfTree.CodeBlock.prototype.dump=function(e){for(var r="",t=0;t<e;t++)r+=" ";r+="|-BLOCK",console.log(r);for(var s=0;s<this.terms.length;s++)this.terms[s].dump(e+1)},Glaemscribe.Eval={},Glaemscribe.Eval.Token=function(e,r){this.name=e,this.expression=r},Glaemscribe.Eval.Token.prototype.is_regexp=function(){return this.expression instanceof RegExp},Glaemscribe.Eval.Token.prototype.clone=function(e){var r=new Glaemscribe.Eval.Token(this.name,this.expression);return r.value=e,r},Glaemscribe.Eval.Lexer=function(e){this.exp=e,this.token_chain=[],this.retain_last=!1},Glaemscribe.Eval.Lexer.prototype.uneat=function(){this.retain_last=!0},Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS=[new Glaemscribe.Eval.Token("bool_or","||"),new Glaemscribe.Eval.Token("bool_and","&&"),new Glaemscribe.Eval.Token("cond_inf_eq","<="),new Glaemscribe.Eval.Token("cond_inf","<"),new Glaemscribe.Eval.Token("cond_sup_eq",">="),new Glaemscribe.Eval.Token("cond_sup",">"),new Glaemscribe.Eval.Token("cond_eq","=="),new Glaemscribe.Eval.Token("cond_not_eq","!="),new Glaemscribe.Eval.Token("add_plus","+"),new Glaemscribe.Eval.Token("add_minus","-"),new Glaemscribe.Eval.Token("mult_times","*"),new Glaemscribe.Eval.Token("mult_div","/"),new Glaemscribe.Eval.Token("mult_modulo","%"),new Glaemscribe.Eval.Token("prim_not","!"),new Glaemscribe.Eval.Token("prim_lparen","("),new Glaemscribe.Eval.Token("prim_rparen",")"),new Glaemscribe.Eval.Token("prim_string",/^'[^']*'/),new Glaemscribe.Eval.Token("prim_string",/^"[^"]*"/),new Glaemscribe.Eval.Token("prim_const",/^[a-zA-Z0-9_.]+/)],Glaemscribe.Eval.Lexer.prototype.TOKEN_END=new Glaemscribe.Eval.Token("prim_end",""),Glaemscribe.Eval.Lexer.prototype.advance=function(){if(this.exp=this.exp.trim(),1==this.retain_last)return this.retain_last=!1,this.token_chain[this.token_chain.length-1];if(this.exp==Glaemscribe.Eval.Lexer.prototype.TOKEN_END.expression){var e=Glaemscribe.Eval.Lexer.prototype.TOKEN_END.clone("");return this.token_chain.push(e),e}for(e=0;e<Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS.length;e++){var r=Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS[e];if(r.is_regexp()){var t=this.exp.match(r.expression);if(t){var s=t[0];this.exp=this.exp.substring(s.length);e=r.clone(s);return this.token_chain.push(e),e}}else if(0==this.exp.indexOf(r.expression)){this.exp=this.exp.substring(r.expression.length);e=r.clone(r.expression);return this.token_chain.push(e),e}}throw"UnknownToken"},Glaemscribe.Eval.Parser=function(){},Glaemscribe.Eval.Parser.prototype.parse=function(e,r){return this.lexer=new Glaemscribe.Eval.Lexer(e),this.vars=r,this.parse_top_level()},Glaemscribe.Eval.Parser.prototype.parse_top_level=function(){return this.explore_bool()},Glaemscribe.Eval.Parser.prototype.explore_bool=function(){for(var e=this.explore_compare(),r=!1;!r;)switch(this.lexer.advance().name){case"bool_or":1==e?this.explore_bool():e=this.explore_compare();break;case"bool_and":1==!e?this.explore_bool():e=this.explore_compare();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_compare=function(){for(var e=this.explore_add(),r=!1;!r;)switch(this.lexer.advance().name){case"cond_inf_eq":e=e<=this.explore_add();break;case"cond_inf":e=e<this.explore_add();break;case"cond_sup_eq":e=e>=this.explore_add();break;case"cond_sup":e=e>this.explore_add();break;case"cond_eq":e=e==this.explore_add();break;case"cond_not_eq":e=e!=this.explore_add();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_add=function(){for(var e=this.explore_mult(),r=!1;!r;)switch(this.lexer.advance().name){case"add_plus":e+=this.explore_mult();break;case"add_minus":e-=this.explore_mult();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_mult=function(){for(var e=this.explore_primary(),r=!1;!r;)switch(this.lexer.advance().name){case"mult_times":e*=this.explore_primary();break;case"mult_div":e/=this.explore_primary();break;case"mult_modulo":e%=this.explore_primary();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_primary=function(){var e=this.lexer.advance(),r=null;switch(e.name){case"prim_const":r=this.cast_constant(e.value);break;case"add_minus":r=-this.explore_primary();break;case"prim_not":r=!this.explore_primary();break;case"prim_lparen":if(r=this.parse_top_level(),"prim_rparen"!=this.lexer.advance().name)throw"Missing right parenthesis.";break;default:throw"Cannot understand: "+e.value+"."}return r},Glaemscribe.Eval.Parser.prototype.constant_is_float=function(e){return!isNaN(e)&&Number(e)%1!=0},Glaemscribe.Eval.Parser.prototype.constant_is_int=function(e){return!isNaN(e)&&Number(e)%1==0},Glaemscribe.Eval.Parser.prototype.constant_is_string=function(e){if(e.length<2)return!1;var r=e[0],t=e[e.length-1];return r==t&&("'"==t||'"'==t)},Glaemscribe.Eval.Parser.prototype.cast_constant=function(e){var r=null;if(this.constant_is_int(e))return parseInt(e);if(this.constant_is_float(e))return parseFloat(e);if(r=e.match(/^\'(.*)\'$/))return r[0];if(r=e.match(/^\"(.*)\"$/))return r[0];if("true"==e)return!0;if("false"==e)return!1;if("nil"==e)return null;if(null!=this.vars[e])return this.vars[e];throw"Cannot understand constant '"+e+"'."},Glaemscribe.TranscriptionTreeNode=function(e,r,t){var s=this;s.character=e,s.replacement=r,s.path=t,s.siblings={}},Glaemscribe.TranscriptionTreeNode.prototype.is_effective=function(){return null!=this.replacement},Glaemscribe.TranscriptionTreeNode.prototype.add_subpath=function(e,r,t){if(null!=e&&""!=e){var s=this,a=e[0],o=s.siblings[a],n=(t||"")+a;null==o&&(o=new Glaemscribe.TranscriptionTreeNode(a,null,n)),s.siblings[a]=o,1==e.length?o.replacement=r:o.add_subpath(e.substring(1),r,n)}},Glaemscribe.TranscriptionTreeNode.prototype.transcribe=function(e,r){if(null==r&&(r=[]),r.push(this),""!=e){var t=e[0],s=this.siblings[t];if(s)return s.transcribe(e.substring(1),r)}for(;1<r.length;){var a=r.pop();if(a.is_effective())return[a.replacement,r.length]}return[["*UNKNOWN"],1]},Glaemscribe.PrePostProcessorOperator=function(e,r){return this.mode=e,this.glaeml_element=r,this},Glaemscribe.PrePostProcessorOperator.prototype.apply=function(){throw"Pure virtual method, should be overloaded."},Glaemscribe.PrePostProcessorOperator.prototype.eval_arg=function(e,r){if(null==e)return null;var t=null;if(t=e.match(/^\\eval\s/)){var s=e.substring(t[0].length);return(new Glaemscribe.Eval.Parser).parse(s,r)}return e},Glaemscribe.PrePostProcessorOperator.prototype.finalize_glaeml_element=function(e,t){for(var s=this,r=0;r<e.args.length;r++)try{e.args[r]=s.eval_arg(e.args[r],t)}catch(a){this.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Failed to evaluate expression '"+e.args[r]+"'."));break}return glaemEach(e.children,function(e,r){s.finalize_glaeml_element(r,t)}),e},Glaemscribe.PrePostProcessorOperator.prototype.finalize=function(e){var r=this;r.finalized_glaeml_element=r.finalize_glaeml_element(r.glaeml_element.clone(),e)},Glaemscribe.PreProcessorOperator=function(e,r){return Glaemscribe.PrePostProcessorOperator.call(this,e,r),this},Glaemscribe.PreProcessorOperator.inheritsFrom(Glaemscribe.PrePostProcessorOperator),Glaemscribe.PostProcessorOperator=function(e,r){return Glaemscribe.PrePostProcessorOperator.call(this,e,r),this},Glaemscribe.PostProcessorOperator.inheritsFrom(Glaemscribe.PrePostProcessorOperator),Glaemscribe.TranscriptionPrePostProcessor=function(e){return this.mode=e,this.root_code_block=new Glaemscribe.IfTree.CodeBlock,this},Glaemscribe.TranscriptionPrePostProcessor.prototype.finalize=function(t){this.operators=[],this.descend_if_tree(this.root_code_block,t),glaemEach(this.operators,function(e,r){r.finalize(t)})},Glaemscribe.TranscriptionPrePostProcessor.prototype.descend_if_tree=function(e,r){for(var t=0;t<e.terms.length;t++){var s=e.terms[t];if(s.is_pre_post_processor_operators())for(var a=0;a<s.operators.length;a++){var o=s.operators[a];this.operators.push(o)}else for(var n=0;n<s.if_conds.length;n++){var i=s.if_conds[n],l=new Glaemscribe.Eval.Parser,c=!1;try{c=l.parse(i.expression,r)}catch(p){this.mode.errors.push(new Glaemscribe.Glaeml.Error(i.line,"Failed to evaluate condition '"+i.expression+"'."))}if(1==c){this.descend_if_tree(i.child_code_block,r);break}}}},Glaemscribe.TranscriptionPreProcessor=function(e){return Glaemscribe.TranscriptionPrePostProcessor.call(this,e),this},Glaemscribe.TranscriptionPreProcessor.inheritsFrom(Glaemscribe.TranscriptionPrePostProcessor),Glaemscribe.TranscriptionPreProcessor.prototype.apply=function(e){for(var r=e,t=0;t<this.operators.length;t++){r=this.operators[t].apply(r)}return r},Glaemscribe.TranscriptionPostProcessor=function(e){return Glaemscribe.TranscriptionPrePostProcessor.call(this,e),this},Glaemscribe.TranscriptionPostProcessor.inheritsFrom(Glaemscribe.TranscriptionPrePostProcessor),Glaemscribe.TranscriptionPostProcessor.prototype.apply=function(e,t){var r=" ";e=e.filter(function(e){return""!==e});for(var s=0;s<this.operators.length;s++){e=this.operators[s].apply(e,t)}null!=this.out_space&&(r=this.out_space.map(function(e){var r=t.n2c(e);return r?r.output():Glaemscribe.UNKNOWN_CHAR_OUTPUT}).join(""));for(var a="",o=0;o<e.length;o++){var n=e[o];switch(n){case"":break;case"*UNKNOWN":a+=Glaemscribe.UNKNOWN_CHAR_OUTPUT;break;case"*SPACE":a+=r;break;case"*LF":a+="\n";default:var i=t.n2c(n);a+=i?i.output():Glaemscribe.UNKNOWN_CHAR_OUTPUT}}return a},Glaemscribe.TranscriptionProcessor=function(e){return this.mode=e,this.rule_groups={},this},Glaemscribe.TranscriptionProcessor.prototype.finalize=function(t){var n=this,a=this.mode;n.transcription_tree=new Glaemscribe.TranscriptionTreeNode(null,null,""),n.transcription_tree.add_subpath(Glaemscribe.WORD_BOUNDARY_TREE,[""]),n.transcription_tree.add_subpath(Glaemscribe.WORD_BREAKER,[""]),glaemEach(this.rule_groups,function(e,r){r.finalize(t)}),n.in_charset={},glaemEach(this.rule_groups,function(s,e){glaemEach(e.in_charset,function(e,r){var t=n.in_charset[e];null!=t?a.errors.push(new Glaemscribe.Glaeml.Error(0,"Group "+s+" uses input character "+e+" which is also used by group "+t.name+". Input charsets should not intersect between groups.")):n.in_charset[e]=r})}),glaemEach(this.rule_groups,function(e,r){for(var t=0;t<r.rules.length;t++)for(var s=r.rules[t],a=0;a<s.sub_rules.length;a++){var o=s.sub_rules[a];n.add_subrule(o)}})},Glaemscribe.TranscriptionProcessor.prototype.add_subrule=function(e){var r=e.src_combination.join("");this.transcription_tree.add_subpath(r,e.dst_combination)},Glaemscribe.TranscriptionProcessor.prototype.apply=function(e,r){for(var t=[],s=null,a="",o=e.split(""),n=0;n<o.length;n++){var i=o[n];switch(i){case" ":case"\t":t=(t=t.concat(this.transcribe_word(a,r))).concat("*SPACE"),a="";break;case"\r":break;case"\n":t=(t=t.concat(this.transcribe_word(a,r))).concat("*LF"),a="";break;default:var l=this.in_charset[i];l==s?a+=i:(t=t.concat(this.transcribe_word(a,r)),s=l,a=i)}}return t=t.concat(this.transcribe_word(a,r))},Glaemscribe.TranscriptionProcessor.prototype.transcribe_word=function(e,r){var t=[];for(e=Glaemscribe.WORD_BOUNDARY_TREE+e+Glaemscribe.WORD_BOUNDARY_TREE;0!=e.length;){var s=this.transcription_tree.transcribe(e),a=s[0],o=s[1],n=e.substring(0,o);e=e.substring(o),t=t.concat(a),r.processor_pathes.push([n,a,a])}return t},Glaemscribe.DowncasePreProcessorOperator=function(e,r){return Glaemscribe.PreProcessorOperator.call(this,e,r),this},Glaemscribe.DowncasePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.DowncasePreProcessorOperator.prototype.apply=function(e){return e.toLowerCase()},Glaemscribe.resource_manager.register_pre_processor_class("downcase",Glaemscribe.DowncasePreProcessorOperator),Glaemscribe.RxSubstitutePreProcessorOperator=function(e,r){return Glaemscribe.PreProcessorOperator.call(this,e,r),this},Glaemscribe.RxSubstitutePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.RxSubstitutePreProcessorOperator.prototype.finalize=function(e){Glaemscribe.PreProcessorOperator.prototype.finalize.call(this,e),this.finalized_glaeml_element.args[1]=this.finalized_glaeml_element.args[1].replace(/(\\\d)/g,function(e){return"$"+e.replace("\\","")})},Glaemscribe.RxSubstitutePreProcessorOperator.prototype.apply=function(e){var r=new RegExp(this.finalized_glaeml_element.args[0],"g"),t=this.finalized_glaeml_element.args[1];return e.replace(r,t)},Glaemscribe.resource_manager.register_pre_processor_class("rxsubstitute",Glaemscribe.RxSubstitutePreProcessorOperator),Glaemscribe.SubstitutePreProcessorOperator=function(e,r){return Glaemscribe.PreProcessorOperator.call(this,e,r),this},Glaemscribe.SubstitutePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.SubstitutePreProcessorOperator.prototype.apply=function(e){for(var r=e,t=this.finalized_glaeml_element.args[0],s=this.finalized_glaeml_element.args[1],a=[],o=t.length,n=r.indexOf(t);-1!==n;)a.push(r.substring(0,n)),a.push(s),n=(r=r.substring(n+o)).indexOf(t);return a.push(r),a.join("")},Glaemscribe.resource_manager.register_pre_processor_class("substitute",Glaemscribe.SubstitutePreProcessorOperator),Glaemscribe.UpDownTehtaSplitPreProcessorOperator=function(e,r){return Glaemscribe.PreProcessorOperator.call(this,e,r),this},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.finalize=function(e){Glaemscribe.PreProcessorOperator.prototype.finalize.call(this,e);var r=this.finalized_glaeml_element.args,t=r[0],s=r[1];t=t.split(/,/).map(function(e){return e.trim()}),s=s.split(/,/).map(function(e){return e.trim()}),this.vowel_map={},this.consonant_map={},this.splitter_tree=new Glaemscribe.TranscriptionTreeNode(null,null,""),this.word_split_map={};for(var a=0;a<t.length;a++){var o=t[a];this.splitter_tree.add_subpath(o,o),this.vowel_map[o]=o}for(var n=0;n<s.length;n++){var i=s[n];this.splitter_tree.add_subpath(i,i),this.consonant_map[i]=i}for(var l=uniqueArray(t.concat(s).join("").split("").sort()),c=0;c<l.length;c++){var p=l[c];this.word_split_map[p]=p}},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.type_of_token=function(e){return null!=this.vowel_map[e]?"V":null!=this.consonant_map[e]?"C":"X"},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.apply_to_word=function(e){var r=[];if(""==e.trim())r.push(e);else for(;0!=e.length;){var t=this.splitter_tree.transcribe(e),s=t[0],a=t[1];Array.isArray(s)&&arrayEquals(s,[Glaemscribe.UNKNOWN_CHAR_OUTPUT])?r.push(e[0]):r.push(s),e=e.substring(a)}for(var o=[],n=0;n<r.length-2;){var i=r[n],l=r[n+1],c=r[n+2],p=this.type_of_token(i),u=this.type_of_token(l),_=this.type_of_token(c);"C"==p&&"V"==u&&"C"==_?(o.push(r[n]),o.push("@"),o.push(r[n+1]),n+=2):(o.push(r[n]),n+=1)}for(;n<r.length;)o.push(r[n]),n+=1;return o.join("")},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.apply=function(e){for(var r="",t="",s=e.split(""),a=0;a<s.length;a++){var o=s[a];null!=this.word_split_map[o]?r+=o:(t+=this.apply_to_word(r),t+=o,r="")}return t+=this.apply_to_word(r)},Glaemscribe.resource_manager.register_pre_processor_class("up_down_tehta_split",Glaemscribe.UpDownTehtaSplitPreProcessorOperator),Glaemscribe.ElvishNumbersPreProcessorOperator=function(e,r){return Glaemscribe.PreProcessorOperator.call(this,e,r),this},Glaemscribe.ElvishNumbersPreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.ElvishNumbersPreProcessorOperator.prototype.apply=function(e){var r=this,a=r.finalized_glaeml_element.args[0];a=null!=a?parseInt(a):12;var o=r.finalized_glaeml_element.args[1];return o=null==o||(1==o||"true"==o),e.replace(/\d+/g,function(e){var r=parseInt(e).toString(a);r=r.toUpperCase();var t="";if(o)for(var s=r.length-1;0<=s;s--)t+=r[s];else t=r;return t})},Glaemscribe.resource_manager.register_pre_processor_class("elvish_numbers",Glaemscribe.ElvishNumbersPreProcessorOperator),Glaemscribe.ReversePostProcessorOperator=function(e,r){return Glaemscribe.PostProcessorOperator.call(this,e,r),this},Glaemscribe.ReversePostProcessorOperator.inheritsFrom(Glaemscribe.PostProcessorOperator),Glaemscribe.ReversePostProcessorOperator.prototype.apply=function(e){return e.reverse()},Glaemscribe.resource_manager.register_post_processor_class("reverse",Glaemscribe.ReversePostProcessorOperator),Glaemscribe.ResolveVirtualsPostProcessorOperator=function(e,r){return Glaemscribe.PostProcessorOperator.call(this,e,r),this},Glaemscribe.ResolveVirtualsPostProcessorOperator.inheritsFrom(Glaemscribe.PostProcessorOperator),Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.finalize=function(e){Glaemscribe.PostProcessorOperator.prototype.finalize.call(this,e),this.last_triggers={}},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.reset_trigger_states=function(e){var t=this;glaemEach(e.virtual_chars,function(e,r){r.object_reference=e,t.last_triggers[r.object_reference]=null})},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.apply_loop=function(e,r,t,s,a,o){var n=this;if("*SPACE"!=a&&"*LF"!=a){var i=e.n2c(a);if(null!=i){if(i.is_virtual()&&s==i.reversed){var l=n.last_triggers[i.object_reference];null!=l&&(t[o]=l.names[0],a=t[o])}glaemEach(e.virtual_chars,function(e,r){var t=r.n2c(a);null!=t&&(n.last_triggers[r.object_reference]=t)})}}else n.reset_trigger_states(e)},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.apply_sequences=function(s,e){var a=[];return glaemEach(e,function(e,r){var t=s.n2c(r);t&&t.is_sequence()?Array.prototype.push.apply(a,t.sequence):a.push(r)}),a},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.apply_swaps=function(e,r){for(var t=0;t<r.length-1;t++){var s=r[t],a=r[t+1],o=e.swap_for_trigger(s);o&&o.has_target(a)&&(r[t+1]=s,r[t]=a)}return r},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.apply=function(t,s){var a=this;t=a.apply_sequences(s,t);var o=(t=a.apply_swaps(s,t)).slice(0);return a.reset_trigger_states(s),glaemEach(t,function(e,r){a.apply_loop(s,t,o,!1,r,e)}),a.reset_trigger_states(s),glaemEachReversed(t,function(e,r){a.apply_loop(s,t,o,!0,r,e)}),o},Glaemscribe.resource_manager.register_post_processor_class("resolve_virtuals",Glaemscribe.ResolveVirtualsPostProcessorOperator),Glaemscribe.OutspacePostProcessorOperator=function(e,r){return Glaemscribe.PostProcessorOperator.call(this,e,r),this.out_space=stringListToCleanArray(r.args[0],/\s/),this},Glaemscribe.OutspacePostProcessorOperator.inheritsFrom(Glaemscribe.PostProcessorOperator),Glaemscribe.OutspacePostProcessorOperator.prototype.apply=function(e){return this.mode.post_processor.out_space=this.out_space,e},Glaemscribe.resource_manager.register_post_processor_class("outspace",Glaemscribe.OutspacePostProcessorOperator),function(){function t(r,t){return a(t).forEach(function(e){o.call(r,e)||c(r,e,p(t,e))}),r}function e(e,o,n){var r;return o&&T&&(r=new WeakMap),n=t(n||{},E),function i(t){if(g(t))return t;if(v(t))return t;var e=y(t);switch(e){case"[object Array]":case"[object Object]":if(r){if(r.has(t))return t;r.set(t,!0)}var s=G(t),a=s?[]:l(u(t));return n.enumerator(t).forEach(function(e){if(s&&"length"===e)a.length=t.length;else if(n.descriptors){var r=p(t,e);if(n.filter&&!n.filter(r,e,t))return;o&&"value"in r&&(r.value=i(t[e])),c(a,e,r)}else a[e]=i(t[e])}),n.extensibility&&(b(t)||d(a),m(t)&&f(a),h(t)&&_(a)),a;case"[object RegExp]":case"[object Date]":case"[object String]":case"[object Number]":case"[object Boolean]":return o?new t.constructor(t.valueOf()):t;default:throw TypeError(e+" is not supported")}}(e)}if(!Object.freeze||"function"!=typeof Object.freeze)throw Error("ES5 support required");var r=Object,s=r.prototype,l=r.create,c=r.defineProperty,a=(r.defineProperties,r.getOwnPropertyNames),p=r.getOwnPropertyDescriptor,u=r.getPrototypeOf,_=r.freeze,h=r.isFrozen,m=r.isSealed,f=r.seal,b=r.isExtensible,d=r.preventExtensions,o=s.hasOwnProperty,n=s.toString,G=Array.isArray,g=(Array.prototype.slice,function(e){return e!==Object(e)}),v=function(e){return"function"==typeof e},y=function(e){return n.call(e)},T=function(){try{var e=new WeakMap;return e.set(e,e),e.get(e)===e}catch(r){return!1}}(),E={descriptors:!0,extensibility:!0,enumerator:a},i=function(r){var t=l(null);return a(r).forEach(function(e){t[e]={value:r[e],configurable:!0,writable:!0,enumerable:!1}}),t},w=function(r,t){return a(t).forEach(function(e){o.call(r,e)||c(r,e,t[e])}),r};(Object.installProperties||w)(Object,i({glaem_clone:e}))}(),(Glaemscribe=void 0===Glaemscribe?{}:Glaemscribe).TTS=function(){this.proxy=new ESpeakNGGlue},Glaemscribe.TTS.ipa_configurations={"en-tengwar":{punct_token:"\uf8e0",block_token:"\uf8e1",clauseaffecting_punctuation:"!.,;:!?\u2013\u2014",clauseunaffecting_punctuation:'\xb7\u201c\u201d\xab\xbb-[](){}\u27e8\u27e9<>\u2264\u2265$|"'}},Glaemscribe.TTS.ipa_configurations["en-tengwar"]=Glaemscribe.TTS.ipa_configurations["en-tengwar"],Glaemscribe.TTS.ipa_configurations["en-tengwar-rp"]=Glaemscribe.TTS.ipa_configurations["en-tengwar"],Glaemscribe.TTS.ipa_configurations["en-tengwar-gb"]=Glaemscribe.TTS.ipa_configurations["en-tengwar"],Glaemscribe.TTS.ipa_configurations["en-tengwar-us"]=Glaemscribe.TTS.ipa_configurations["en-tengwar"],Glaemscribe.TTS.voice_list=function(){return Object.keys(Glaemscribe.TTS.ipa_configurations)},Glaemscribe.TTS.option_name_to_voice=function(e){return e?e.toLowerCase().replace(/^espeak_voice_/,"").replace(/_/g,"-"):null},Glaemscribe.TTS.prototype.make_char_checker=function(e){for(var r={},t=0;t<e.length;t++)r[e[t]]=e[t];return r},Glaemscribe.TTS.prototype.isSpace=function(e){return" "==e||"\t"==e},Glaemscribe.TTS.prototype.read_cap_token=function(e,r,t){var s=this,a=r;if(null==t[e[a]])return null;for(a++;a<e.length&&(null!=t[e[a]]||s.isSpace(e[a]));a++);var o=a-r;for(a=r+o-1;r<=a&&s.isSpace(e[a]);a--)o--;return e.substring(r,r+o)},Glaemscribe.TTS.prototype.preceded_by_space=function(e,r){return!(r<=0)&&this.isSpace(e[r-1])},Glaemscribe.TTS.prototype.succeeded_by_space=function(e,r){var t=this;return!(r>=e.length-1)&&t.isSpace(e[r+1])},Glaemscribe.TTS.prototype.escape_special_blocks=function(e,r,a){var o=Glaemscribe.TTS.ipa_configurations[e],t=a?/(\s*)({{[\s\S]*?}}|\b[0-9][0-9\s]*\b)(\s*)/g:/(\s*)({{[\s\S]*?}})(\s*)/g,n=[];return[r.replace(t,function(e,r,t,s){return n.push(e),a?r+o.block_token+s:" "}),n]},Glaemscribe.TTS.prototype.ipa_instrument_punct=function(e,r){for(var t=this,s=Glaemscribe.TTS.ipa_configurations[e],a=t.make_char_checker(s.clauseaffecting_punctuation),o=t.make_char_checker(s.clauseunaffecting_punctuation),n="",i=[],l=null,c=0;c<r.length;c++)"\n"==r[c]?(n+=s.punct_token,i.push(r[c])):null!=o[r[c]]?(n+=" "+s.punct_token+" ",i.push((t.preceded_by_space(r,c)?" ":"")+r[c]+(t.succeeded_by_space(r,c)?" ":""))):(l=t.read_cap_token(r,c,a))?(n+=" "+r[c]+" "+s.punct_token+" ",i.push((t.preceded_by_space(r,c)?" ":"")+l+(t.succeeded_by_space(r,c+l.length-1)?" ":"")),c+=l.length-1):n+=r[c];return[n,i]},Glaemscribe.TTS.prototype.wav_instrument_punct=function(e,r){for(var t=this,
s=Glaemscribe.TTS.ipa_configurations[e],a=t.make_char_checker(s.clauseaffecting_punctuation),o="",n=null,i=0;i<r.length;i++)(n=t.read_cap_token(r,i,a))?(o+=r[i],i+=n.length-1):o+=r[i];return o},Glaemscribe.TTS.prototype.ipa_instrument_blocks=function(e,r){Glaemscribe.TTS.ipa_configurations[e];return this.escape_special_blocks(e,r,!0)},Glaemscribe.TTS.prototype.ipa_restore_tokens=function(e,r,t){var s=new RegExp("\\s*("+r+")\\s*","g"),a=-1;return e=e.replace(s,function(){return t[a+=1]})},Glaemscribe.TTS.prototype.post_ipa=function(e,r,t){var s=this,a=Glaemscribe.TTS.ipa_configurations[e];return r=r.replace(/\n/g," "),r=s.ipa_restore_tokens(r,a.punct_token,t.punct_tokens),"\n"===(r=s.ipa_restore_tokens(r,a.block_token,t.block_tokens))[r.length-1]&&(r=r.slice(0,-1)),r},Glaemscribe.TTS.prototype.pre_ipa=function(e,r,t){var s=this;if(!Glaemscribe.TTS.ipa_configurations[r])throw"Trying to use unsupported voice '"+r+"'!";t=t.replace(/\t/g," "),t+="\n";var a=s.ipa_instrument_blocks(r,t);t=a[0];var o=s.ipa_instrument_punct(r,t);return{text:t=(t=o[0]).replace(/(\.\s+.)/g,function(e,r){return r.toUpperCase()}),block_tokens:a[1],punct_tokens:o[1]}},Glaemscribe.TTS.prototype.pre_wav=function(e,r,t){if(!Glaemscribe.TTS.ipa_configurations[r])throw"Trying to use unsupported voice '"+r+"'!";e.has_raw_mode&&(t=this.escape_special_blocks(r,t,!1)[0]);return{text:t=this.wav_instrument_punct(r,t)}},Glaemscribe.TTS.prototype.synthesize_ipa=function(e,r,t){var s=this,a=(r=r||{}).voice||"en-tengwar",o=s.pre_ipa(r,a,e);e=o.text,s.proxy.set_voice(a);var n=new Date,i={};return s.proxy.synthesize(e,!1,!0,!0,function(e){e.ipa=s.post_ipa(a,e.pho,o);var r=new Date;e.synthesis_time=r-n,delete e.pho,t&&t(e),i=e}),i},Glaemscribe.TTS.prototype.synthesize_wav=function(e,r,t){var s=this,a=(r=r||{}).voice||"en-tengwar";e=s.pre_wav(r,a,e).text,s.proxy.set_rate(r.rate||120),s.proxy.set_pitch(r.pitch||5),s.proxy.set_voice(a);var o=new Date,n={};return s.proxy.synthesize(e,!0,!1,!1,function(e){var r=new Date;e.synthesis_time=r-o,delete e.pho,t&&t(e),n=e}),n},Glaemscribe.TTS.TokenType={},Glaemscribe.TTS.TokenType.WORD="WORD",Glaemscribe.TTS.TokenType.NON_WORD="NON_WORD",Glaemscribe.TTS.TokenType.NUM="NUM",Glaemscribe.TTS.TokenType.SPACE="SPACE",Glaemscribe.TTS.TokenType.PUNCT="PUNCT",Glaemscribe.TTS.prototype.orthographic_disambiguator_en=function(e){for(var r=this,s=/(\p{L}+)/u,t=e.split(s).map(function(e){var r={},t=e.match(s);return r.type=t?Glaemscribe.TTS.TokenType.WORD:Glaemscribe.TTS.TokenType.NON_WORD,r.content=e,r}),a=[],o=0;o<t.length;o++)if(0!=o&&o!=t.length-1&&t[o].type!=Glaemscribe.TTS.TokenType.WORD)if("'"==t[o].content&&t[o-1].type==Glaemscribe.TTS.TokenType.WORD&&t[o+1].type==Glaemscribe.TTS.TokenType.WORD){a.pop();var n={};n.type=Glaemscribe.TTS.TokenType.WORD,n.content=t[o-1].content+t[o].content+t[o+1].content,a.push(n),o+=1}else a.push(t[o]);else a.push(t[o]);o=0;(t=a).forEach(function(e){e.num=o,o+=1});var i=t.filter(function(e){return e.type==Glaemscribe.TTS.TokenType.WORD}),l=i.map(function(e){return e.content}).join(" \uf8e0 "),c={}.voice||"en-tengwar";r.proxy.set_voice(c),r.proxy.synthesize(l,!1,!0,!0,function(e){l=e.pho}),l=l.split("\uf8e0").map(function(e){return e.trim()});var p=0;return l.forEach(function(){t[i[p].num].ipa=l[p],p+=1}),t},Glaemscribe.TTS.is_engine_loaded=function(){return"undefined"!=typeof ESpeakNGGlue};